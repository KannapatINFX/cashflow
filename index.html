<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cashflow Canvas ‚Äî v1.4 (Readable Charts)</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#ffffff; --line:#e2e8f0;
          --green:#16a34a; --red:#dc2626; --blue:#2563eb; --amber:#f59e0b; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  main{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }
  fieldset{border:1px solid var(--line);border-radius:12px;padding:12px;margin:0}
  legend{padding:0 8px;color:var(--muted);font-weight:600}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  label{display:flex;flex-direction:column;gap:6px;margin:6px 0}
  input,select,button,textarea{padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:8px 10px;border-radius:999px;background:#f8fafc}
  .stack{display:flex;flex-direction:column;gap:10px}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{display:flex;justify-content:flex-end}
  .danger{color:var(--red)}
  .ok{color:var(--green)}
  canvas{width:100%;height:320px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .mini{height:260px}
  .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .kpi{font-weight:700;font-size:18px}
  .legend{display:flex;gap:12px;align-items:center;font-size:12px;color:var(--muted)}
  .legend .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#f8fafc;cursor:pointer}
  .btn[aria-pressed="true"]{background:#e0f2fe;border-color:#93c5fd}
  .tip{position:absolute;pointer-events:none;background:#111;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;transform:translate(-50%,-110%);white-space:nowrap}
</style>
</head>
<body>
<header>
  <h1>üí∏ Cashflow Canvas</h1>
  <div class="toolbar" style="margin-left:auto">
    <span class="pill">v1.4</span>
    <label class="pill">‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (‡∏ß‡∏±‡∏ô)
      <input id="horizon" type="number" min="30" max="730" value="180" style="width:90px">
    </label>
    <button class="btn" id="btn-run">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
  </div>
</header>

<main>
  <section class="stack">
    <fieldset>
      <legend>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ & ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô</legend>
      <div class="stack">
        <div class="row">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ <input id="acc-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏´‡∏•‡∏±‡∏Å / KBank" /></label>
          <label>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó) <input id="acc-balance" type="number" step="0.01" value="75000" /></label>
        </div>
        <div class="right"><button class="btn" id="btn-add-acc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button></div>
        <table id="tbl-accounts"><thead><tr><th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th style="width:30%">‡∏¢‡∏≠‡∏î (‡∏ö‡∏≤‡∏ó)</th><th style="width:50px"></th></tr></thead><tbody></tbody></table>
      </div>
    </fieldset>

    <fieldset>
      <legend>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (Recurring)</legend>
      <div class="stack">
        <div class="row">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <input id="rec-name" placeholder="‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ / ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏ô"></label>
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó <select id="rec-type"><option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select></label>
        </div>
        <div class="row">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) <input id="rec-amount" type="number" step="0.01" value="35000"></label>
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà <select id="rec-frequency"><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option><option value="biweekly">‡∏ó‡∏∏‡∏Å 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option></select></label>
        </div>
        <div id="monthly-fields" class="row">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1‚Äì31) <input id="rec-day" type="number" min="1" max="31" value="25"></label>
          <label>‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå <select id="rec-weekend"><option value="stay">‡∏ï‡∏£‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°</option><option value="next_business_day">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</option><option value="prev_business_day">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option></select></label>
        </div>
        <div id="weekly-fields" class="row" style="display:none">
          <label>‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå <select id="rec-weekday"><option value="1">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="2">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option><option value="3">‡∏û‡∏∏‡∏ò</option><option value="4">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option><option value="5" selected>‡∏®‡∏∏‡∏Å‡∏£‡πå</option><option value="6">‡πÄ‡∏™‡∏≤‡∏£‡πå</option><option value="0">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option></select></label>
          <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà (YYYY-MM-DD) <input id="rec-start" type="date"></label>
        </div>
        <div class="right"><button class="btn" id="btn-add-rec">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</button></div>
        <table id="tbl-recurring"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </fieldset>

    <fieldset>
      <legend>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</legend>
      <div class="stack">
        <div class="row">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£ <input id="cc-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô SCB / UOB"></label>
          <label>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á (‡∏ö‡∏≤‡∏ó) <input id="cc-balance" type="number" step="0.01" value="20000"></label>
        </div>
        <div class="row">
          <label>APR ‡∏ï‡πà‡∏≠‡∏õ‡∏µ (%) <input id="cc-apr" type="number" step="0.01" value="18"></label>
          <label>‡∏ß‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö <input id="cc-stmday" type="number" min="1" max="31" value="15"></label>
        </div>
        <div class="row">
          <label>‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö (‡∏ß‡∏±‡∏ô) <input id="cc-dueoffset" type="number" min="5" max="30" value="15"></label>
          <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (% / ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ö‡∏≤‡∏ó) <input id="cc-min" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5 / 200" value="5 / 200"></label>
        </div>
        <div class="right"><button class="btn" id="btn-add-cc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button></div>
        <table id="tbl-cc"><thead><tr><th>‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á</th><th>APR%</th><th>‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö</th><th>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th><th>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </fieldset>
  </section>

  <section class="stack">
    <fieldset>
      <legend>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° & ‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢</legend>
      <div class="legend">
        <span><span class="dot" style="background:var(--blue)"></span> ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∞‡∏™‡∏°</span>
        <span><span class="dot" style="background:var(--green)"></span> ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ö‡∏ß‡∏Å</span>
        <span><span class="dot" style="background:var(--red)"></span> ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏•‡∏ö</span>
        <span><span class="dot" style="background:#000;border:1px solid #000"></span> ‡πÄ‡∏™‡πâ‡∏ô 0 ‡∏ö‡∏≤‡∏ó</span>
      </div>
      <div class="toolbar">
        ‡∏î‡∏π‡∏ä‡πà‡∏ß‡∏á: 
        <button class="btn" data-span="30" aria-pressed="true">30 ‡∏ß‡∏±‡∏ô</button>
        <button class="btn" data-span="60">60 ‡∏ß‡∏±‡∏ô</button>
        <button class="btn" data-span="90">90 ‡∏ß‡∏±‡∏ô</button>
      </div>
      <canvas id="chart" width="1200" height="340"></canvas>
      <div id="tooltip" class="tip" style="display:none"></div>
      <div class="muted">‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô = ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∞‡∏™‡∏° (‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡πÑ‡∏•‡πà‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÅ‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) ‚Ä¢ ‡πÄ‡∏™‡πâ‡∏ô‡∏î‡∏≥‡∏´‡∏ô‡∏≤ = 0 ‡∏ö‡∏≤‡∏ó ‚Ä¢ ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ó‡∏≤‡∏Å‡∏∂‡πà‡∏á‡∏ö‡∏≤‡∏á = ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
    </fieldset>

    <fieldset>
      <legend>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</legend>
      <div id="cc-advice" class="card">‚Äî</div>
      <table id="tbl-cc-schedule"><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th><th>‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö</th><th>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</th></tr></thead><tbody></tbody></table>
    </fieldset>

    <fieldset>
      <legend>‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</legend>
      <table id="tbl-timeline"><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>In</th><th>Out</th><th>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∞‡∏™‡∏°</th></tr></thead><tbody></tbody></table>
    </fieldset>
  </section>
</main>

<script>
const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmt(n){ return Number(n).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2}); }
function iso(d){ return d.toISOString().slice(0,10); }
function isWeekend(d){ const wd=d.getDay(); return wd===0||wd===6; }
function adjustWeekend(d,rule='stay'){
  if(rule==='stay') return d;
  if(!isWeekend(d)) return d;
  let nd=new Date(d);
  if(rule==='next_business_day'){ while(isWeekend(nd)) nd.setDate(nd.getDate()+1); return nd; }
  if(rule==='prev_business_day'){ while(isWeekend(nd)) nd.setDate(nd.getDate()-1); return nd; }
  return d;
}

const store = { accounts:[], recurring:[], oneoff:[], creditcards:[] };
(function seed(){
  store.accounts.push({name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏´‡∏•‡∏±‡∏Å', balance:60000});
  const t=new Date(); const y=t.getFullYear(), m=t.getMonth();
  store.recurring.push({name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'income', amount:35000, frequency:'monthly', day:25, weekendRule:'prev_business_day', startDate: iso(new Date(y,m,1))});
  store.recurring.push({name:'‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ', type:'expense', amount:12000, frequency:'monthly', day:5, weekendRule:'next_business_day', startDate: iso(new Date(y,m,1))});
  store.creditcards.push({name:'SCB', balance:20000, apr:18, stmday:15, dueoffset:15, minpct:5, minfloor:200, weekendRule:'stay'});
})();

function renderTables(){
  const tbA=$('#tbl-accounts tbody'); tbA.innerHTML='';
  store.accounts.forEach((a,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.name}</td><td><span class="${a.balance<0?'danger':'ok'}">${fmt(a.balance)}</span></td><td><button data-del-acc="${i}">‡∏•‡∏ö</button></td>`;
    tbA.appendChild(tr);
  });
  const tbR=$('#tbl-recurring tbody'); tbR.innerHTML='';
  store.recurring.forEach((r,i)=>{
    const info = r.frequency==='monthly'? `‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${r.day}` : (r.frequency==='weekly'?`‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå`:'‡∏ó‡∏∏‡∏Å 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td>${r.type==='income'?'‡∏£‡∏±‡∏ö':'‡∏à‡πà‡∏≤‡∏¢'}</td><td>${fmt(r.amount)}</td><td>${r.frequency}</td><td>${info}</td><td><button data-del-rec="${i}">‡∏•‡∏ö</button></td>`;
    tbR.appendChild(tr);
  });
  const tbC=$('#tbl-cc tbody'); tbC.innerHTML='';
  store.creditcards.forEach((c,i)=>{
    const due='+'+c.dueoffset+'d ‡∏´‡∏•‡∏±‡∏á '+c.stmday; const minshow = c.minpct+'% / '+fmt(c.minfloor);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.name}</td><td>${fmt(c.balance)}</td><td>${c.apr}</td><td>${c.stmday}</td><td>${due}</td><td>${minshow}</td><td><button data-del-cc="${i}">‡∏•‡∏ö</button></td>`;
    tbC.appendChild(tr);
  });
  $$('button[data-del-acc]').forEach(b=>b.onclick=()=>{const i=+b.getAttribute('data-del-acc');store.accounts.splice(i,1);renderTables();computeAndDraw();});
  $$('button[data-del-rec]').forEach(b=>b.onclick=()=>{const i=+b.getAttribute('data-del-rec');store.recurring.splice(i,1);renderTables();computeAndDraw();});
  $$('button[data-del-cc]').forEach(b=>b.onclick=()=>{const i=+b.getAttribute('data-del-cc');store.creditcards.splice(i,1);renderTables();computeAndDraw();});
}

$('#btn-add-acc').onclick=()=>{const name=$('#acc-name').value.trim();const bal=Number(($('#acc-balance').value||'0').toString().replace(/,/g,''));if(!name)return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');store.accounts.push({name,balance:bal});$('#acc-name').value='';renderTables();computeAndDraw();};
$('#btn-add-rec').onclick=()=>{const name=$('#rec-name').value.trim();if(!name)return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');const type=$('#rec-type').value;const amount=Number(($('#rec-amount').value||'0').toString().replace(/,/g,''));const f=$('#rec-frequency').value;const weekendRule=$('#rec-weekend').value;const startDate=$('#rec-start').value||iso(new Date());let payload={name, type, amount, frequency:f, weekendRule, startDate}; if(f==='monthly'){payload.day=Math.max(1,Math.min(31,Number($('#rec-day').value||1)));} else {payload.weekday=Number($('#rec-weekday').value);} store.recurring.push(payload);$('#rec-name').value='';renderTables();computeAndDraw();};
$('#btn-add-cc').onclick=()=>{const name=$('#cc-name').value.trim();if(!name)return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£');const balance=Number(($('#cc-balance').value||'0').toString().replace(/,/g,''));const apr=Number($('#cc-apr').value||18);const stmday=Math.max(1,Math.min(31,Number($('#cc-stmday').value||15)));const dueoffset=Math.max(5,Math.min(45,Number($('#cc-dueoffset').value||15)));const [pct,floor]=($('#cc-min').value||'5 / 200').split('/').map(s=>Number(s));store.creditcards.push({name,balance,apr,stmday,dueoffset,minpct:pct||5,minfloor:floor||200,weekendRule:'stay'});$('#cc-name').value='';renderTables();computeAndDraw();};
$('#rec-frequency').onchange=()=>{const f=$('#rec-frequency').value;$('#monthly-fields').style.display=(f==='monthly')?'grid':'none';$('#weekly-fields').style.display=(f!=='monthly')?'grid':'none';};
$('#btn-run').onclick=()=>computeAndDraw();
$$('button[data-span]').forEach(btn=>btn.onclick=()=>{$$('button[data-span]').forEach(b=>b.setAttribute('aria-pressed','false'));btn.setAttribute('aria-pressed','true'); drawChartsCached(Number(btn.dataset.span)||30);});

function expandRecurring(h){
  const today=new Date(); today.setHours(0,0,0,0);
  const until=new Date(today); until.setDate(until.getDate()+h);
  const events=[]; const y0=today.getFullYear(), m0=today.getMonth();
  const monthsCount=Math.ceil(h/30)+1;
  for(const r of store.recurring){
    if(r.frequency==='monthly'){
      for(let k=0;k<monthsCount;k++){
        const d=new Date(y0,m0+k,1); const y=d.getFullYear(), m=d.getMonth();
        const ld=new Date(y,m+1,0).getDate(); const day=Math.min(r.day||1, ld);
        let when=new Date(y,m,day); when=adjustWeekend(when, r.weekendRule||'stay');
        const sdate=r.startDate? new Date(r.startDate): new Date(y0,m0,1);
        if(when>=sdate && when>=today && when<=until){ events.push({date: iso(when), type:r.type, amount:Number(r.amount)}); }
      }
    }else{
      const weekday=('weekday' in r)? Number(r.weekday):5;
      let cur=r.startDate? new Date(r.startDate): new Date(today);
      if(cur.getDay()!==weekday){ const diff=(7+weekday-cur.getDay())%7; cur.setDate(cur.getDate()+diff); }
      while(cur<=until){ if(cur>=today){ events.push({date:iso(cur), type:r.type, amount:Number(r.amount)}); } cur=new Date(cur); cur.setDate(cur.getDate() + (r.frequency==='biweekly'?14:7)); }
    }
  }
  return events;
}

function expandCreditCards(h){
  const today=new Date(); today.setHours(0,0,0,0);
  const until=new Date(today); until.setDate(until.getDate()+h);
  const schedules=[], cashflowEvents=[];
  for(const c of store.creditcards){
    let bal=Number(c.balance||0); const monthlyRate=Number(c.apr||18)/12/100;
    let cur=new Date(today.getFullYear(), today.getMonth(), Math.min(c.stmday, new Date(today.getFullYear(), today.getMonth()+1, 0).getDate()));
    if(cur<today){ cur=new Date(today.getFullYear(), today.getMonth()+1, Math.min(c.stmday, new Date(today.getFullYear(), today.getMonth()+2, 0).getDate())); }
    while(cur<=until && bal>0.01){
      const interest=bal*monthlyRate; const stmt=bal+interest;
      const min1=stmt*(Number(c.minpct||5)/100); const minpay=Math.max(min1, Number(c.minfloor||200));
      const due=new Date(cur); due.setDate(due.getDate()+Number(c.dueoffset||15)); const dueAdj=adjustWeekend(due, c.weekendRule||'stay');
      schedules.push({date:iso(dueAdj), name:c.name, statement:stmt, minpay:Math.min(minpay,stmt), interest});
      cashflowEvents.push({date:iso(dueAdj), type:'expense', amount:Math.min(minpay,stmt)});
      bal = Math.max(0, stmt-minpay);
      const nm=new Date(cur.getFullYear(), cur.getMonth()+1, 1);
      cur=new Date(nm.getFullYear(), nm.getMonth(), Math.min(c.stmday, new Date(nm.getFullYear(), nm.getMonth()+1, 0).getDate()));
    }
  }
  schedules.sort((a,b)=>a.date.localeCompare(b.date));
  return {schedules, cashflowEvents};
}

function creditCardAdvice(){
  if(store.creditcards.length===0) return '‚Äî';
  const ranked=[...store.creditcards].sort((a,b)=> (b.apr - a.apr) || (b.balance - a.balance));
  const lines=ranked.map((c,i)=> `${i+1}. ‡∏õ‡∏¥‡∏î <b>${c.name}</b> ‡∏Å‡πà‡∏≠‡∏ô (APR ${c.apr}% | ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á ${fmt(c.balance)})`);
  return `‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏•‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏ö‡∏ö <b>Debt Avalanche</b>:<br>` + lines.join('<br>');
}

function computeTimeline(h){
  const today=new Date(); today.setHours(0,0,0,0);
  const until=new Date(today); until.setDate(until.getDate()+h);
  const startBalance=store.accounts.reduce((s,a)=>s+Number(a.balance||0),0);
  const rec=expandRecurring(h);
  const {schedules, cashflowEvents}=expandCreditCards(h);
  renderCCSchedule(schedules); $('#cc-advice').innerHTML=creditCardAdvice();
  const oneFuture=store.oneoff.filter(o=>{ const d=new Date(o.date); d.setHours(0,0,0,0); return d>=today && d<=until; });
  const byDate=new Map();
  const add=(d,t,amt)=>{ const x=byDate.get(d)||{in:0,out:0}; if(t==='income') x.in+=amt; else x.out+=amt; byDate.set(d,x); };
  rec.forEach(e=>add(e.date,e.type,e.amount)); cashflowEvents.forEach(e=>add(e.date,e.type,e.amount)); oneFuture.forEach(o=>add(o.date,o.type,Number(o.amount)));
  const rows=[]; let running=startBalance;
  for(let d=new Date(today); d<=until; d.setDate(d.getDate()+1)){
    const k=d.toISOString().slice(0,10); const v=byDate.get(k)||{in:0,out:0}; const net=v.in - v.out; running+=net;
    rows.push({date:k, inflow:v.in, outflow:v.out, net, running});
  }
  return {rows, startBalance};
}

function renderCCSchedule(items){
  const tb=$('#tbl-cc-schedule tbody'); tb.innerHTML='';
  items.forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.date}</td><td>${it.name}</td><td>${fmt(it.statement)}</td><td>${fmt(it.minpay)}</td><td>${fmt(it.interest)}</td>`; tb.appendChild(tr); });
}

let cachedRows=[];
function computeAndDraw(){ const h=Number($('#horizon').value||180); const res=computeTimeline(h); cachedRows=res.rows; drawChartsCached(30); renderTimelineTable(res.rows); renderTables(); }
function drawChartsCached(span){ drawReadableChart(cachedRows.slice(0,span)); }

function drawReadableChart(rows){
  const cvs=$('#chart'), ctx=cvs.getContext('2d'); const W=cvs.width, H=cvs.height;
  ctx.clearRect(0,0,W,H);
  if(rows.length===0){ ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',20,24); return; }
  const padL=50, padR=20, padT=20, padB=40;
  const xs=i=> padL + i*(W-padL-padR)/Math.max(1, rows.length-1);
  const vals=rows.map(r=>r.running);
  const vMin=Math.min(0, ...vals), vMax=Math.max(0, ...vals);
  const ys=v=> padT + (vMax - v) * (H-padT-padB) / (vMax - vMin || 1);
  // weekly grid
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  for(let i=0;i<rows.length;i+=7){ const x=xs(i); ctx.beginPath(); ctx.moveTo(x,padT); ctx.lineTo(x,H-padB); ctx.stroke(); }
  // zero line
  const y0=ys(0); ctx.strokeStyle='#000'; ctx.lineWidth=1.5; ctx.beginPath(); ctx.moveTo(padL,y0); ctx.lineTo(W-padR,y0); ctx.stroke();
  // area fills
  for(let i=1;i<rows.length;i++){
    const x1=xs(i-1), x2=xs(i), y1=ys(rows[i-1].running), y2=ys(rows[i].running);
    // above
    ctx.fillStyle='rgba(22,163,74,0.12)'; ctx.beginPath(); ctx.moveTo(x1,Math.min(y1,y0)); ctx.lineTo(x2,Math.min(y2,y0)); ctx.lineTo(x2,y0); ctx.lineTo(x1,y0); ctx.closePath(); ctx.fill();
    // below
    ctx.fillStyle='rgba(220,38,38,0.12)'; ctx.beginPath(); ctx.moveTo(x1,Math.max(y1,y0)); ctx.lineTo(x2,Math.max(y2,y0)); ctx.lineTo(x2,y0); ctx.lineTo(x1,y0); ctx.closePath(); ctx.fill();
  }
  // main line
  ctx.strokeStyle='#2563eb'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(xs(0), ys(rows[0].running));
  for(let i=1;i<rows.length;i++){ ctx.lineTo(xs(i), ys(rows[i].running)); } ctx.stroke();
  // daily bars
  const bw=(W-padL-padR)/rows.length * 0.6;
  for(let i=0;i<rows.length;i++){
    const x=xs(i)-bw/2, v=rows[i].net; const y=ys(v>0?v:0); const yb=ys(v<0?v:0);
    ctx.fillStyle= v>=0 ? '#16a34a' : '#dc2626';
    ctx.fillRect(x, v>=0? y : y0, bw, Math.abs(y - y0));
  }
  // labels
  ctx.fillStyle='#475569'; ctx.font='12px system-ui';
  ctx.fillText(fmt(vMax), 6, padT+12); ctx.fillText(fmt(vMin), 6, H-padB+12);
  ctx.textAlign='center';
  for(let i=0;i<rows.length;i+=7){ const x=xs(i); ctx.fillText(rows[i].date.slice(5), x, H-12); }
  // tooltip
  const tip=$('#tooltip'); cvs.onmousemove=e=>{
    const r=cvs.getBoundingClientRect(), px=e.clientX-r.left;
    let idx=Math.round((px-padL)*(rows.length-1)/(W-padL-padR)); idx=Math.max(0,Math.min(rows.length-1,idx));
    const d=rows[idx]; if(!d) return tip.style.display='none';
    tip.style.display='block'; tip.style.left=(xs(idx))+'px'; tip.style.top=(ys(d.running))+'px';
    tip.innerHTML=`${d.date}<br>In ${fmt(d.inflow)} ‚Ä¢ Out ${fmt(d.outflow)}<br><b>Net ${d.net>=0?'+':''}${fmt(d.net)}</b> | Running ${fmt(d.running)}`;
  };
  cvs.onmouseleave=()=> tip.style.display='none';
}

function renderTimelineTable(rows){
  const tb=$('#tbl-timeline tbody'); tb.innerHTML='';
  rows.slice(0,120).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.date}</td><td class="ok">${fmt(r.inflow)}</td><td class="danger">-${fmt(r.outflow)}</td><td>${fmt(r.net)}</td><td><strong>${fmt(r.running)}</strong></td>`;
    tb.appendChild(tr);
  });
  if(rows.length>120){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="5" class="muted">‚Ä¶‡πÅ‡∏™‡∏î‡∏á 120 ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡∏ß‡∏±‡∏ô</td>`; tb.appendChild(tr); }
}

renderTables(); computeAndDraw();
</script>
</body>
</html>